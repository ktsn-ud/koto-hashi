generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "cockroachdb"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// bot server -> LINE API
model LineApiRequestLog {
  id             String   @id @default(uuid())
  occurredAt     DateTime
  xLineRequestId String
  httpMethod     String // POST/GET/...
  apiEndpoint    String // 例: https://api.line.me/v2/bot/message/reply
  lineStatusCode Int // LINE が返した status code

  @@index([occurredAt])
}

// LINE API -> bot server
model LineWebhookLog {
  id                String   @id @default(uuid())
  occurredAt        DateTime
  senderIp          String // webhook sender IP
  requestPath       String // 例: /webhook
  serverStatusCode  Int // bot server が webhook に返した status code
  webhookHttpMethod String // POST な

  @@index([occurredAt])
}

// webhook event ログ
enum WebhookEventStatus {
  RECEIVED
  PROCESSING
  DONE
  FAILED_RETRYABLE
  FAILED_TERMINAL
  IGNORED
}

model LineWebhookEvent {
  id               String             @id @default(uuid())
  webhookEventId   String             @unique
  status           WebhookEventStatus @default(RECEIVED)
  receivedAt       DateTime           @default(now())
  lineTimestampMs  BigInt
  eventType        String
  sourceUserId     String?
  replyToken       String?
  messageText      String?
  messageId        String?
  attemptCount     Int                @default(0)
  lastErrorMessage String?
  nextTryAt        DateTime?

  @@index([status, nextTryAt]) // 処理すべきイベントを検索する用
  @@index([receivedAt]) // 定期削除用
}
